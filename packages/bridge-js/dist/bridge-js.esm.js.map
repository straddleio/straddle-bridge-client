{"version":3,"file":"bridge-js.esm.js","sources":["../src/index.ts"],"sourcesContent":["import { EBridgeMessageType, TMessage, TMode } from '@straddlecom/bridge-core'\nexport type { TMode } from '@straddlecom/bridge-core'\ntype TOnLoadErrorParams = { error_code: 'iframe_error'; error: ErrorEvent; message: string } | { error_code: 'init_error'; message: any; origin: string }\ntype TOnSuccessParams = import('@straddlecom/bridge-core').TPaykeyResponse\n\nconst IFRAME_ID = 'Straddle-widget-iframe'\nconst BRIDGE_CLIENT_LOG_LABEL_STYLE = 'color: #14b8a6; padding: 0px; border-radius: 24px; font-weight: 600;'\nconst BRIDGE_SERVER_LOG_LABEL_STYLE = 'color: #a855f7; padding: 0px; border-radius: 24px; font-weight: 600;'\n\nconst consoleDictionary: any = {\n    log: { conditionFn: (verbose: boolean) => verbose },\n    error: { conditionFn: (verbose: boolean) => true },\n    warn: { conditionFn: (verbose: boolean) => true },\n    info: { conditionFn: (verbose: boolean) => verbose },\n    debug: { conditionFn: (verbose: boolean) => verbose },\n    table: { conditionFn: (verbose: boolean) => verbose },\n}\nconst log = (...args: any[]) => console.log('%c●%c', BRIDGE_CLIENT_LOG_LABEL_STYLE, '', ...args)\nconst warn = (...args: any[]) => console.warn('%c●%c', BRIDGE_CLIENT_LOG_LABEL_STYLE, '', ...args)\nconst error = (...args: any[]) => console.error('%c●%c', BRIDGE_CLIENT_LOG_LABEL_STYLE, '', ...args)\n\nconst getParentOrigin = () => [\n    typeof window !== 'undefined' && encodeURIComponent(window.location.origin.replace('https://', '').replace('http://', '')),\n    typeof window !== 'undefined' && window.location.protocol.replace(':', ''),\n]\n\nconst appUrlDictionary: Record<TMode, string> = {\n    production: 'https://bridge.straddle.com',\n    sandbox: 'https://bridge-sandbox.straddle.com',\n}\n\nconst getAppURLFromMode = (mode?: TMode) => appUrlDictionary[mode ?? 'sandbox']\n\ndeclare global {\n    interface Window {\n        __STRADDLE_BRIDGE__?: {\n            mounted: boolean\n            mounting: boolean\n            owner?: symbol\n        }\n    }\n}\nconst getGlobalBridgeState = () => {\n    if (typeof window === 'undefined') {\n        return { mounted: false, mounting: false }\n    }\n    if (!window.__STRADDLE_BRIDGE__) {\n        window.__STRADDLE_BRIDGE__ = { mounted: false, mounting: false }\n    }\n    return window.__STRADDLE_BRIDGE__!\n}\n\nexport const straddleBridge = {\n    getUrl: () => {\n        const [parentOrigin, protocol] = getParentOrigin()\n        return `${straddleBridge.origin}/?parentOriginURL=${parentOrigin}&parentOriginProtocol=${protocol}`\n    },\n    origin: '',\n    mounted: false,\n    verbose: false,\n    owner: undefined as undefined | symbol,\n    messageHandler: undefined as undefined | ((event: MessageEvent<TMessage>) => void),\n    iframeErrorHandler: undefined as undefined | ((errorEvent: ErrorEvent) => void),\n    init: function init(params: {\n        mode?: TMode\n        appUrl?: string\n        token: string\n        onSuccess: (payload: TOnSuccessParams) => void\n        onSuccessCTAClicked?: () => void\n        onClose?: () => void\n        onLoadError?: (err: TOnLoadErrorParams) => void\n        allowManualEntry?: boolean\n        onManualEntry?: () => void\n        onRetry?: () => void\n        targetRef?: HTMLElement | undefined\n        style?: Partial<CSSStyleDeclaration>\n        className?: string\n        verbose?: boolean\n    }) {\n        let {\n            mode,\n            appUrl,\n            token,\n            onSuccess,\n            onSuccessCTAClicked,\n            onClose,\n            onLoadError,\n            allowManualEntry = true,\n            onManualEntry,\n            onRetry,\n            targetRef,\n            style,\n            className,\n            verbose = false,\n        } = params\n        appUrl = appUrl ?? getAppURLFromMode(mode)\n        appUrl = appUrl.endsWith('/') ? appUrl.slice(0, -1) : appUrl\n        straddleBridge.origin = appUrl ?? 'https://bridge.straddle.com'\n        straddleBridge.verbose = !!verbose\n        verbose && log('init called')\n        const gs = getGlobalBridgeState()\n        if (gs.mounting || gs.mounted) {\n            verbose && warn('StraddleBridge already mounted; skipping duplicate mount.')\n            return\n        }\n        gs.mounting = true\n        straddleBridge.owner = Symbol('STRADDLE_BRIDGE_OWNER')\n        gs.owner = straddleBridge.owner\n        const iframe = document.createElement('iframe')\n        iframe.setAttribute('src', `${straddleBridge.getUrl()}&allowManualEntry=${allowManualEntry}`)\n        straddleBridge.iframeErrorHandler = (errorEvent: ErrorEvent) => {\n            error('Error loading Straddle Widget')\n            onLoadError?.({ error_code: 'iframe_error', error: errorEvent, message: 'Error loading Straddle Widget' })\n        }\n        iframe.addEventListener('error', straddleBridge.iframeErrorHandler)\n        iframe.id = IFRAME_ID\n        let iframe_style = style\n        if (!style) {\n            iframe_style = { position: 'fixed', width: '100%', height: '100%', top: '0%', left: '0', zIndex: '2147483647' }\n        }\n        Object.assign(iframe.style, iframe_style)\n\n        if (className) {\n            className.split(' ').forEach((className) => {\n                iframe.classList.add(className)\n            })\n        }\n        ;(targetRef || document.getElementsByTagName('body')[0]).appendChild(iframe)\n        if (typeof window !== 'undefined') {\n            if (straddleBridge.messageHandler) {\n                window.removeEventListener('message', straddleBridge.messageHandler)\n            }\n            straddleBridge.messageHandler = function (event: MessageEvent<TMessage>) {\n                const rawMessage = event.data as any\n                const message = {\n                    ...rawMessage,\n                    type: typeof rawMessage?.type === 'string' ? rawMessage.type.replace('@straddleio/', '@straddlecom/') : rawMessage?.type,\n                } as TMessage\n                if (message?.type?.includes('@straddlecom/') && event.origin !== straddleBridge.origin) {\n                    verbose && log('Message received from Bridge app but from unknown origin:', event.origin, event.data)\n                }\n                // Make sure the message is from the expected origin\n                if (event.origin === straddleBridge.origin) {\n                    verbose && message.type !== EBridgeMessageType.CONSOLE && log('Message received from Bridge app:', message.type, event)\n                    switch (message.type) {\n                        case EBridgeMessageType.PING:\n                            break\n                        case EBridgeMessageType.MOUNTED:\n                            straddleBridge.mounted = true\n                            straddleBridge.send({ type: EBridgeMessageType.INITIALIZE, token })\n                            break\n                        case EBridgeMessageType.ON_CLOSE:\n                            onClose?.()\n                            straddleBridge.remove()\n                            break\n                        case EBridgeMessageType.ON_SUCCESS_CTA_CLICKED:\n                            onSuccessCTAClicked?.()\n                            straddleBridge.remove()\n                            break\n                        case EBridgeMessageType.ON_MANUAL_ENTRY:\n                            onManualEntry?.()\n                            break\n                        case EBridgeMessageType.ON_RETRY:\n                            onRetry?.()\n                            break\n                        case EBridgeMessageType.ON_PAYKEY:\n                            onSuccess?.(message.paykeyResponse)\n                            break\n                        case EBridgeMessageType.ERROR:\n                            onLoadError?.({ error_code: 'init_error', ...message.payload, origin: event.origin })\n                            break\n                        case EBridgeMessageType.CONSOLE:\n                            {\n                                const parsedPayload: any = (message as any).payload.map((item: any) => {\n                                    try {\n                                        return JSON.parse(item)\n                                    } catch {\n                                        return item\n                                    }\n                                })\n                                if ('method' in message) {\n                                    const method = (message as any).method as keyof typeof console\n                                    consoleDictionary[method]?.conditionFn(!!verbose) &&\n                                        (console[method] as Function).apply(console, ['%c●%c', BRIDGE_SERVER_LOG_LABEL_STYLE, '', ...parsedPayload])\n                                }\n                            }\n                            break\n                    }\n                }\n            }\n            window.addEventListener('message', straddleBridge.messageHandler)\n        }\n        gs.mounting = false\n        gs.mounted = true\n    },\n    getIframe: () => document.getElementById(IFRAME_ID) as HTMLIFrameElement,\n    show: () => {\n        straddleBridge.verbose && console.log('straddleBridge.show method called.')\n        const iframe = straddleBridge.getIframe()\n        straddleBridge.verbose && iframe && console.log('iframe found, setting display to block.')\n        iframe.style.display = 'block'\n    },\n    hide: () => {\n        straddleBridge.verbose && console.log('straddleBridge.hide method called.')\n        const iframe = straddleBridge.getIframe()\n        straddleBridge.verbose && iframe && console.log('iframe found, setting display to none.')\n        iframe.style.display = 'none'\n    },\n    remove: () => {\n        straddleBridge.verbose && console.log('straddleBridge.remove method called.')\n        const gs = getGlobalBridgeState()\n        if (!gs.owner || !straddleBridge.owner || gs.owner !== straddleBridge.owner) {\n            straddleBridge.verbose && console.log('remove called by non-owner; ignoring.')\n            return\n        }\n        if (typeof window !== 'undefined' && straddleBridge.messageHandler) {\n            window.removeEventListener('message', straddleBridge.messageHandler)\n            straddleBridge.messageHandler = undefined\n        }\n        const iframe = straddleBridge.getIframe()\n        if (iframe && straddleBridge.iframeErrorHandler) {\n            iframe.removeEventListener('error', straddleBridge.iframeErrorHandler)\n            straddleBridge.iframeErrorHandler = undefined\n        }\n        iframe?.remove()\n        straddleBridge.mounted = false\n        gs.mounted = false\n        gs.mounting = false\n        gs.owner = undefined\n        straddleBridge.owner = undefined\n    },\n    send: function send(message: TMessage) {\n        const iframe = document.getElementById(IFRAME_ID) as HTMLIFrameElement\n        if (iframe) {\n            straddleBridge.verbose && log('Bridge client: Sending message to iframe with target:', straddleBridge.origin, ', message:', message)\n            iframe.contentWindow?.postMessage(message, straddleBridge.origin)\n        } else {\n            straddleBridge.verbose && log('Bridge client', 'No iframe found, message not sent:', message)\n        }\n    },\n}\ntypeof window !== 'undefined' && ((window as any).straddleBridge = straddleBridge)\n\nObject.defineProperty(straddleBridge, 'debug', {\n    value: {\n        enable: () => straddleBridge.send({ type: EBridgeMessageType.DEBUG, enable: true }),\n        disable: () => straddleBridge.send({ type: EBridgeMessageType.DEBUG, enable: false }),\n    },\n    enumerable: false,\n    writable: false,\n    configurable: false,\n})\n"],"names":["IFRAME_ID","BRIDGE_CLIENT_LOG_LABEL_STYLE","consoleDictionary","log","conditionFn","verbose","error","warn","info","debug","table","args","console","appUrlDictionary","production","sandbox","getGlobalBridgeState","window","mounted","mounting","__STRADDLE_BRIDGE__","straddleBridge","getUrl","parentOrigin","protocol","encodeURIComponent","location","origin","replace","owner","undefined","messageHandler","iframeErrorHandler","init","params","mode","appUrl","token","onSuccess","onSuccessCTAClicked","onClose","onLoadError","allowManualEntry","onManualEntry","onRetry","targetRef","style","className","getAppURLFromMode","endsWith","slice","gs","Symbol","iframe","document","createElement","setAttribute","errorEvent","error_code","message","addEventListener","id","iframe_style","position","width","height","top","left","zIndex","Object","assign","split","forEach","classList","add","getElementsByTagName","appendChild","removeEventListener","event","rawMessage","data","type","_a","includes","EBridgeMessageType","CONSOLE","PING","MOUNTED","send","INITIALIZE","ON_CLOSE","remove","ON_SUCCESS_CTA_CLICKED","ON_MANUAL_ENTRY","ON_RETRY","ON_PAYKEY","paykeyResponse","ERROR","payload","parsedPayload","map","item","JSON","parse","method","_b","apply","getIframe","getElementById","show","display","hide","contentWindow","postMessage","defineProperty","value","enable","DEBUG","disable","enumerable","writable","configurable"],"mappings":"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"}
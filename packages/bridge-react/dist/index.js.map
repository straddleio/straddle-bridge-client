{"version":3,"file":"index.js","sources":["../src/StraddleBridge.tsx"],"sourcesContent":["import { EBridgeMessageType, TMessage, TMode, TPaykeyResponse } from '@straddleio/bridge-core'\nimport { CSSProperties, forwardRef, useEffect, useRef, useState } from 'react'\nexport type { TMode } from '@straddleio/bridge-core'\n\nconst IFRAME_ID = 'Straddle-widget-iframe'\n\nconst appUrlDictionary: Record<TMode, string> = {\n    production: 'https://bridge.straddle.io',\n    sandbox: 'https://bridge-sandbox.straddle.io',\n}\n\nconst getAppURLFromMode = (mode?: TMode) => appUrlDictionary[mode ?? 'production']\n\nexport const useStraddleBridge = ({ mode, appUrl }: { mode?: TMode; appUrl?: string }) => {\n    appUrl = appUrl ?? getAppURLFromMode(mode)\n    appUrl = appUrl.endsWith('/') ? appUrl.slice(0, -1) : appUrl\n    const [bridgeAppMounted, setBridgeAppMounted] = useState(false)\n    const parentOrigin = getParentOrigin()\n    const url = `${appUrl}/${parentOrigin}/`\n    const send = (message: TMessage) => {\n        const iframe = document.getElementById(IFRAME_ID) as HTMLIFrameElement\n        if (iframe) {\n            iframe.contentWindow?.postMessage(message, appUrl)\n        }\n    }\n    return { send, bridgeAppMounted, setBridgeAppMounted, url, appUrl }\n}\nconst getParentOrigin = () => typeof window !== 'undefined' && encodeURIComponent(window.location.origin.replace('https://', '').replace('http://', ''))\n\ntype TypeStraddleBridgeProps = {\n    mode?: TMode\n    appUrl?: string\n    open?: boolean\n    token: string\n    onSuccess: (payload: TPaykeyResponse) => void\n    onSuccessCTAClicked?: () => void\n    onClose?: () => void\n    onLoadError?: (err: ErrorEvent) => void\n    allowManualEntry?: boolean\n    onManualEntry?: () => void\n    onRetry?: () => void\n    className?: string\n    style?: CSSProperties\n}\n\nexport const StraddleBridge = forwardRef<HTMLElement, TypeStraddleBridgeProps & { verbose?: boolean }>((props, ref) => {\n    const {\n        mode,\n        open = true,\n        token,\n        onSuccess,\n        onSuccessCTAClicked,\n        onClose,\n        onLoadError,\n        allowManualEntry = true,\n        onManualEntry,\n        onRetry,\n        className,\n        style,\n        verbose,\n    } = props\n    const { send, setBridgeAppMounted, url, appUrl } = useStraddleBridge({ mode, appUrl: props.appUrl })\n    const iframeMounted = useRef(false)\n    useEffect(() => {\n        let errorHandler: (errorEvent: ErrorEvent) => void\n        const messageHandler = function (event: MessageEvent<TMessage>) {\n            // Make sure the message is from the expected origin\n            // console.log('Message here', event.origin, appUrl, event.data)\n            if (event.origin === appUrl) {\n                verbose &&\n                    event.data.type !== EBridgeMessageType.CONSOLE &&\n                    console.log('Straddle Bridge React client, Message received from widget:', event.data.type, event)\n                const message = event.data\n                switch (message?.type) {\n                    case EBridgeMessageType.PING:\n                        break\n                    case EBridgeMessageType.MOUNTED:\n                        setBridgeAppMounted(true)\n                        send({ type: EBridgeMessageType.INITIALIZE, token })\n                        break\n                    case EBridgeMessageType.ON_CLOSE:\n                        onClose?.()\n                        setBridgeAppMounted(false)\n                        document.querySelector(`#${IFRAME_ID}`)?.remove()\n                        break\n                    case EBridgeMessageType.ON_SUCCESS_CTA_CLICKED:\n                        onSuccessCTAClicked?.()\n                        break\n                    case EBridgeMessageType.ON_PAYKEY:\n                        onSuccess?.(message.paykeyResponse)\n                        break\n                    case EBridgeMessageType.ON_MANUAL_ENTRY:\n                        onManualEntry?.()\n                        break\n                    case EBridgeMessageType.ON_RETRY:\n                        onRetry?.()\n                        break\n                    case EBridgeMessageType.CONSOLE:\n                        {\n                            const parsedPayload: any = message.payload.map((item: any) => {\n                                try {\n                                    return JSON.parse(item)\n                                } catch {\n                                    return item\n                                }\n                            })\n                            'method' in message && (console[message.method] as Function).apply(console, parsedPayload)\n                        }\n                        break\n                }\n            } else {\n                verbose && console.log('Message received from unknown origin:', event.origin, event.data)\n            }\n        }\n        window.addEventListener('message', messageHandler)\n        if (open && !iframeMounted.current) {\n            let iframe: HTMLIFrameElement | null = document.querySelector('#' + IFRAME_ID)\n            if (!iframe) {\n                iframe = document.createElement('iframe')\n                iframe.setAttribute('src', `${url}?allowManualEntry=${allowManualEntry}`)\n            }\n            errorHandler = (errorEvent: ErrorEvent) => {\n                console.error('Error loading Straddle Widget')\n                onLoadError?.(errorEvent)\n            }\n            if (iframe) {\n                iframe.addEventListener('error', errorHandler)\n            }\n            iframe.id = IFRAME_ID\n            let iframe_style = style\n            if (!style) {\n                iframe_style = { position: 'fixed', width: '100%', height: '100%', top: '0%', left: '0', zIndex: '2147483647' }\n                // iframe_style = { position: 'fixed', width: '100%', height: '100%', top: '0%', left: '0', zIndex: '2147483647', backgroundColor: '#fafaf9' }\n            }\n            iframe_style && Object.assign(iframe.style, iframe_style)\n\n            if (className) {\n                className.split(' ').forEach((className) => {\n                    iframe.classList.add(className)\n                })\n            }\n            if (ref && 'current' in ref && ref.current && ref.current instanceof Node) {\n                ;(ref.current as HTMLElement).appendChild(iframe)\n            } else {\n                if (ref && 'current' in ref && (!ref.current || !(ref.current instanceof Node))) {\n                    console.warn('ref passed to StraddleBridge is not a valid ref, reverting to appening to body. Ref passed:', ref.current)\n                }\n                document.getElementsByTagName('body')[0].appendChild(iframe)\n                iframeMounted.current = true\n            }\n        } else if (!open) {\n            document.querySelector(`#${IFRAME_ID}`)?.remove()\n            iframeMounted.current = false\n            setBridgeAppMounted(false)\n        }\n        return () => {\n            const iframe: HTMLIFrameElement | null = document.querySelector('#' + IFRAME_ID)\n            errorHandler && iframe && iframe.removeEventListener('error', errorHandler)\n            messageHandler && window.removeEventListener('message', messageHandler)\n        }\n    }, [open])\n    useEffect(() => {\n        typeof window !== 'undefined' &&\n            ((window as any).straddleDebug = {\n                enable: () => send({ type: EBridgeMessageType.DEBUG, enable: true }),\n                disable: () => send({ type: EBridgeMessageType.DEBUG, enable: false }),\n            })\n    }, [])\n    return null\n})\n\nStraddleBridge.displayName = 'StraddleBridge'\n"],"names":["IFRAME_ID","appUrlDictionary","production","sandbox","useStraddleBridge","mode","appUrl","getAppURLFromMode","endsWith","slice","bridgeAppMounted","setBridgeAppMounted","useState","parentOrigin","getParentOrigin","send","message","iframe","document","getElementById","_a","contentWindow","postMessage","url","window","encodeURIComponent","location","origin","replace","StraddleBridge","forwardRef","props","ref","open","token","onSuccess","onSuccessCTAClicked","onClose","onLoadError","allowManualEntry","onManualEntry","onRetry","className","style","verbose","iframeMounted","useRef","useEffect","errorHandler","messageHandler","event","data","type","EBridgeMessageType","CONSOLE","console","log","PING","MOUNTED","INITIALIZE","ON_CLOSE","querySelector","remove","ON_SUCCESS_CTA_CLICKED","ON_PAYKEY","paykeyResponse","ON_MANUAL_ENTRY","ON_RETRY","parsedPayload","payload","map","item","JSON","parse","method","apply","addEventListener","current","createElement","setAttribute","errorEvent","error","id","iframe_style","position","width","height","top","left","zIndex","Object","assign","split","forEach","classList","add","Node","appendChild","warn","getElementsByTagName","removeEventListener","straddleDebug","enable","DEBUG","disable","displayName"],"mappings":"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"}
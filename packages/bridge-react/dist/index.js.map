{"version":3,"file":"index.js","sources":["../src/StraddleBridge.tsx"],"sourcesContent":["import { EBridgeMessageType, TOnLoadErrorParams, TOnSuccessParams, TMessage, TMode } from '@straddlecom/bridge-core'\nimport { CSSProperties, forwardRef, useEffect, useRef, useState } from 'react'\nexport type { TMode } from '@straddlecom/bridge-core'\n\nconst IFRAME_ID = 'Straddle-widget-iframe'\nconst BRIDGE_CLIENT_LOG_LABEL_STYLE = 'color: #14b8a6; padding: 0px; border-radius: 24px; font-weight: 600;'\nconst BRIDGE_SERVER_LOG_LABEL_STYLE = 'color: #a855f7; padding: 0px; border-radius: 24px; font-weight: 600;'\n\nconst consoleDictionary: any = {\n    log: { conditionFn: (verbose: boolean) => verbose },\n    error: { conditionFn: (verbose: boolean) => true },\n    warn: { conditionFn: (verbose: boolean) => true },\n    info: { conditionFn: (verbose: boolean) => verbose },\n    debug: { conditionFn: (verbose: boolean) => verbose },\n    table: { conditionFn: (verbose: boolean) => verbose },\n}\nconst log = (...args: any[]) => console.log('%c●%c', BRIDGE_CLIENT_LOG_LABEL_STYLE, '', ...args)\nconst warn = (...args: any[]) => console.warn('%c●%c', BRIDGE_CLIENT_LOG_LABEL_STYLE, '', ...args)\nconst error = (...args: any[]) => console.error('%c●%c', BRIDGE_CLIENT_LOG_LABEL_STYLE, '', ...args)\n\nconst appUrlDictionary: Record<TMode, string> = {\n    production: 'https://bridge.straddle.com',\n    sandbox: 'https://bridge-sandbox.straddle.com',\n}\nconst getAppURLFromMode = (mode?: TMode) => appUrlDictionary[mode ?? 'sandbox']\n\nexport const useStraddleBridge = ({\n    mode,\n    appUrl,\n    allowManualEntry,\n    verbose,\n}: {\n    mode?: TMode\n    appUrl?: string\n    allowManualEntry: boolean\n    verbose?: boolean\n}) => {\n    appUrl = appUrl ?? getAppURLFromMode(mode)\n    appUrl = appUrl.endsWith('/') ? appUrl.slice(0, -1) : appUrl\n    const [bridgeAppMounted, setBridgeAppMounted] = useState(false)\n    const [parentOrigin, protocol] = getParentOrigin()\n    const url = `${appUrl}/?parentOriginURL=${parentOrigin}&parentOriginProtocol=${protocol}&allowManualEntry=${allowManualEntry}`\n    const send = (message: TMessage) => {\n        const iframe = document.getElementById(IFRAME_ID) as HTMLIFrameElement\n        if (iframe) {\n            verbose && log('Sending message to iframe with target:', appUrl, ', message:', message)\n            iframe.contentWindow?.postMessage(message, appUrl)\n        } else {\n            verbose && console.log('No iframe found, message not sent:', message)\n        }\n    }\n    return { send, bridgeAppMounted, setBridgeAppMounted, url, appUrl }\n}\n\nconst getParentOrigin = () => [\n    typeof window !== 'undefined' && encodeURIComponent(window.location.origin.replace('https://', '').replace('http://', '')),\n    typeof window !== 'undefined' && window.location.protocol.replace(':', ''),\n]\n\ndeclare global {\n    interface Window {\n        __STRADDLE_BRIDGE__?: {\n            mounted: boolean\n            mounting: boolean\n            owner?: symbol\n        }\n    }\n}\nconst getGlobalBridgeState = () => {\n    if (typeof window === 'undefined') {\n        return { mounted: false, mounting: false }\n    }\n    if (!window.__STRADDLE_BRIDGE__) {\n        window.__STRADDLE_BRIDGE__ = { mounted: false, mounting: false }\n    }\n    return window.__STRADDLE_BRIDGE__!\n}\n\ntype TypeStraddleBridgeProps = {\n    mode?: TMode\n    appUrl?: string\n    open?: boolean\n    token: string\n    onSuccess: (payload: TOnSuccessParams) => void\n    onSuccessCTAClicked?: () => void\n    onClose?: () => void\n    onLoadError?: (err: TOnLoadErrorParams) => void\n    allowManualEntry?: boolean\n    onManualEntry?: () => void\n    onRetry?: () => void\n    className?: string\n    style?: CSSProperties\n}\n\nexport const StraddleBridge = forwardRef<HTMLElement, TypeStraddleBridgeProps & { verbose?: boolean }>((props, ref) => {\n    const {\n        mode,\n        open = true,\n        token,\n        onSuccess,\n        onSuccessCTAClicked,\n        onClose,\n        onLoadError,\n        allowManualEntry = true,\n        onManualEntry,\n        onRetry,\n        className,\n        style,\n        verbose,\n    } = props\n    const { send, url, appUrl } = useStraddleBridge({ mode, appUrl: props.appUrl, allowManualEntry, verbose })\n    const ownerTokenRef = useRef<symbol | null>(null)\n    useEffect(() => {\n        const globalState = getGlobalBridgeState()\n        // Prevent duplicate mounts: if another instance is already mounting or mounted,\n        // and this instance hasn't mounted its iframe yet, no-op.\n        if (open && (globalState.mounting || globalState.mounted)) {\n            verbose && warn('StraddleBridge already mounted; skipping duplicate mount.')\n            return () => {}\n        }\n        let errorHandler: (errorEvent: ErrorEvent) => void\n        const messageHandler = function (event: MessageEvent<TMessage>) {\n            const rawMessage = event.data as any\n            const message = {\n                ...rawMessage,\n                type: typeof rawMessage?.type === 'string' ? rawMessage.type.replace('@straddleio/', '@straddlecom/') : rawMessage?.type,\n            } as TMessage\n            if (message?.type?.includes('@straddlecom/') && event.origin !== appUrl) {\n                verbose && log('Message received from Bridge app but from unknown origin:', event.origin, event.data)\n            }\n            // Make sure the message is from the expected origin\n            if (event.origin === appUrl) {\n                verbose && message.type !== EBridgeMessageType.CONSOLE && log('Message received from Bridge app:', message.type, event)\n                switch (message.type) {\n                    case EBridgeMessageType.PING:\n                        break\n                    case EBridgeMessageType.MOUNTED:\n                        send({ type: EBridgeMessageType.INITIALIZE, token })\n                        break\n                    case EBridgeMessageType.ON_CLOSE:\n                        onClose?.()\n                        {\n                            const gs = getGlobalBridgeState()\n                            if (gs.owner && ownerTokenRef.current && gs.owner === ownerTokenRef.current) {\n                                document.querySelector(`#${IFRAME_ID}`)?.remove()\n                                gs.mounting = false\n                                gs.mounted = false\n                                gs.owner = undefined\n                            }\n                        }\n                        break\n                    case EBridgeMessageType.ON_SUCCESS_CTA_CLICKED:\n                        onSuccessCTAClicked?.()\n                        {\n                            const gs = getGlobalBridgeState()\n                            if (gs.owner && ownerTokenRef.current && gs.owner === ownerTokenRef.current) {\n                                document.querySelector(`#${IFRAME_ID}`)?.remove()\n                                gs.mounting = false\n                                gs.mounted = false\n                                gs.owner = undefined\n                            }\n                        }\n                        break\n                    case EBridgeMessageType.ON_PAYKEY:\n                        onSuccess?.(message.paykeyResponse)\n                        break\n                    case EBridgeMessageType.ON_MANUAL_ENTRY:\n                        onManualEntry?.()\n                        break\n                    case EBridgeMessageType.ON_RETRY:\n                        onRetry?.()\n                        break\n                    case EBridgeMessageType.ERROR:\n                        onLoadError?.({ error_code: 'init_error', ...message.payload, origin: event.origin })\n                        break\n                    case EBridgeMessageType.CONSOLE:\n                        {\n                            const parsedPayload: any = message.payload.map((item: any) => {\n                                try {\n                                    return JSON.parse(item)\n                                } catch {\n                                    return item\n                                }\n                            })\n                            'method' in message &&\n                                consoleDictionary[message.method]?.conditionFn(verbose) &&\n                                (console[message.method] as Function).apply(console, ['%c●%c', BRIDGE_SERVER_LOG_LABEL_STYLE, '', ...parsedPayload])\n                        }\n                        break\n                }\n            } else {\n                // verbose && log('Message received from unknown origin:', event.origin, event.data)\n            }\n        }\n        window.addEventListener('message', messageHandler)\n        if (open) {\n            globalState.mounting = true\n            ownerTokenRef.current = Symbol('STRADDLE_BRIDGE_OWNER')\n            globalState.owner = ownerTokenRef.current\n            let iframe: HTMLIFrameElement | null = document.querySelector('#' + IFRAME_ID)\n            if (!iframe) {\n                iframe = document.createElement('iframe')\n                iframe.setAttribute('src', url)\n            }\n            errorHandler = (errorEvent: ErrorEvent) => {\n                error('Error loading Straddle Widget')\n                onLoadError?.({ error_code: 'iframe_error', error: errorEvent, message: 'Error loading Straddle Widget' })\n            }\n            if (iframe) {\n                iframe.addEventListener('error', errorHandler)\n            }\n            iframe.id = IFRAME_ID\n            let iframe_style = style\n            if (!style) {\n                iframe_style = { position: 'fixed', width: '100%', height: '100%', top: '0%', left: '0', zIndex: '2147483647' }\n            }\n            iframe_style && Object.assign(iframe.style, iframe_style)\n\n            if (className) {\n                className.split(' ').forEach((className) => {\n                    iframe.classList.add(className)\n                })\n            }\n            if (ref && 'current' in ref && ref.current && ref.current instanceof Node) {\n                ;(ref.current as HTMLElement).appendChild(iframe)\n            } else {\n                if (ref && 'current' in ref && (!ref.current || !(ref.current instanceof Node))) {\n                    warn('ref passed to StraddleBridge is not a valid ref, reverting to appending to body. Ref passed:', ref.current)\n                }\n                document.getElementsByTagName('body')[0].appendChild(iframe)\n            }\n            globalState.mounting = false\n            globalState.mounted = true\n        } else if (!open) {\n            const gs = getGlobalBridgeState()\n            if (gs.owner && ownerTokenRef.current && gs.owner === ownerTokenRef.current) {\n                document.querySelector(`#${IFRAME_ID}`)?.remove()\n                gs.mounting = false\n                gs.mounted = false\n                gs.owner = undefined\n            }\n        }\n        return () => {\n            const iframe: HTMLIFrameElement | null = document.querySelector('#' + IFRAME_ID)\n            errorHandler && iframe && iframe.removeEventListener('error', errorHandler)\n            messageHandler && window.removeEventListener('message', messageHandler)\n            const gs = getGlobalBridgeState()\n            if (gs.owner && ownerTokenRef.current && gs.owner === ownerTokenRef.current) {\n                gs.mounting = false\n                gs.mounted = false\n                gs.owner = undefined\n            }\n        }\n    }, [open])\n    useEffect(() => {\n        typeof window !== 'undefined' &&\n            ((window as any).straddleDebug = {\n                enable: () => send({ type: EBridgeMessageType.DEBUG, enable: true }),\n                disable: () => send({ type: EBridgeMessageType.DEBUG, enable: false }),\n            })\n    }, [])\n    return null\n})\n\nStraddleBridge.displayName = 'StraddleBridge'\n"],"names":["IFRAME_ID","BRIDGE_CLIENT_LOG_LABEL_STYLE","consoleDictionary","log","conditionFn","verbose","error","warn","info","debug","table","args","console","appUrlDictionary","production","sandbox","useStraddleBridge","mode","appUrl","allowManualEntry","getAppURLFromMode","endsWith","slice","bridgeAppMounted","setBridgeAppMounted","useState","parentOrigin","protocol","getParentOrigin","send","message","iframe","document","getElementById","_a","contentWindow","postMessage","url","window","encodeURIComponent","location","origin","replace","getGlobalBridgeState","mounted","mounting","__STRADDLE_BRIDGE__","StraddleBridge","forwardRef","props","ref","open","token","onSuccess","onSuccessCTAClicked","onClose","onLoadError","onManualEntry","onRetry","className","style","ownerTokenRef","useRef","useEffect","globalState","errorHandler","messageHandler","event","rawMessage","data","Object","assign","type","includes","EBridgeMessageType","CONSOLE","PING","MOUNTED","INITIALIZE","ON_CLOSE","gs","owner","current","_b","querySelector","remove","undefined","ON_SUCCESS_CTA_CLICKED","_c","ON_PAYKEY","paykeyResponse","ON_MANUAL_ENTRY","ON_RETRY","ERROR","error_code","payload","parsedPayload","map","item","JSON","parse","_d","method","apply","addEventListener","Symbol","createElement","setAttribute","errorEvent","id","iframe_style","position","width","height","top","left","zIndex","split","forEach","classList","add","Node","appendChild","getElementsByTagName","removeEventListener","straddleDebug","enable","DEBUG","disable","displayName"],"mappings":"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"}